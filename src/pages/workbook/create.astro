---
import Layout from '../../layouts/Layout.astro';
import { ChatBot } from '../../components/workbook/ChatBot';
import { GenerationProgress } from '../../components/workbook/GenerationProgress';
import { t } from '../../i18n/index';
import type { Lang } from '../../i18n/index';

const user = Astro.locals.user;
const lang = Astro.locals.lang as Lang;
const supabase = Astro.locals.supabase;

// Auth check
if (!user) {
  return Astro.redirect('/login');
}

// Premium check
let isPremium = false;
if (supabase) {
  const { data: subs } = await supabase
    .from('subscriptions')
    .select('status')
    .eq('user_id', user.id)
    .in('status', ['active', 'trialing'])
    .limit(1);
  isPremium = (subs?.length ?? 0) > 0;
}

if (!isPremium) {
  return Astro.redirect('/community');
}

// ç”Ÿæˆä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
let generatingWorkbook: { id: string; days_completed: number; topic_label: string; level_label: string; dest_label: string } | null = null;
let canCreate = true;

if (supabase) {
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

  // ã¾ãšç”Ÿæˆä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ã‚’ç¢ºèª
  const { data: generating } = await supabase
    .from('workbooks')
    .select('id, days_completed, topic_label, level_label, dest_label')
    .eq('user_id', user.id)
    .eq('status', 'generating')
    .gte('created_at', monthStart)
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  if (generating) {
    generatingWorkbook = generating;
  } else {
    // ç”Ÿæˆä¸­ãŒãªã‘ã‚Œã°ã€å®Œäº†æ¸ˆã¿ã®æœˆ1å†Šåˆ¶é™ãƒã‚§ãƒƒã‚¯
    const { count } = await supabase
      .from('workbooks')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', user.id)
      .gte('created_at', monthStart);
    canCreate = (count ?? 0) < 1;
  }
}

// Get auto-level from latest assessment (English)
let autoLevelEnglish: string | null = null;
let autoLevelLabelEnglish: string | null = null;

try {
  const englishLevelMap: Record<string, string> = {
    A1: 'eiken5', A2: 'eiken4', B1: 'eiken3', B2: 'toeic400', C1: 'toeic600',
    N5: 'eiken5', N4: 'eiken4', N3: 'eiken3', N2: 'toeic400', N1: 'toeic600',
  };
  const englishLevelLabels: Record<string, string> = {
    eiken5: 'è‹±æ¤œ5ç´šï¼ˆä¸­1ç¨‹åº¦ï¼‰', eiken4: 'è‹±æ¤œ4ç´šï¼ˆä¸­2ç¨‹åº¦ï¼‰', eiken3: 'è‹±æ¤œ3ç´šï¼ˆä¸­3ç¨‹åº¦ï¼‰',
    toeic400: 'TOEIC 400ç‚¹ãƒ¬ãƒ™ãƒ«', toeic600: 'TOEIC 600ç‚¹ãƒ¬ãƒ™ãƒ«',
  };

  const { data: assessment } = await supabase
    .from('assessment_results')
    .select('text_level, voice_level')
    .eq('user_id', user.id)
    .eq('language', 'english')
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  if (assessment) {
    const bestLevel = (assessment.text_level ?? assessment.voice_level) as string | null;
    if (bestLevel && englishLevelMap[bestLevel]) {
      autoLevelEnglish = englishLevelMap[bestLevel];
      autoLevelLabelEnglish = englishLevelLabels[autoLevelEnglish] ?? null;
    }
  }
} catch {
  // No English assessment found
}

// Get auto-level from latest assessment (Japanese)
let autoLevelJapanese: string | null = null;
let autoLevelLabelJapanese: string | null = null;

try {
  const japaneseLevelMap: Record<string, string> = {
    N5: 'jlpt_n5', N4: 'jlpt_n4', N3: 'jlpt_n3', N2: 'jlpt_n2', N1: 'jlpt_n1',
    A1: 'jlpt_n5', A2: 'jlpt_n4', B1: 'jlpt_n3', B2: 'jlpt_n2', C1: 'jlpt_n1',
  };
  const japaneseLevelLabels: Record<string, string> = {
    jlpt_n5: 'JLPT N5ï¼ˆå…¥é–€ï¼‰', jlpt_n4: 'JLPT N4ï¼ˆåˆç´šï¼‰', jlpt_n3: 'JLPT N3ï¼ˆä¸­ç´šï¼‰',
    jlpt_n2: 'JLPT N2ï¼ˆä¸Šç´šå‰åŠï¼‰', jlpt_n1: 'JLPT N1ï¼ˆä¸Šç´šï¼‰',
  };

  const { data: assessment } = await supabase
    .from('assessment_results')
    .select('text_level, voice_level')
    .eq('user_id', user.id)
    .eq('language', 'japanese')
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  if (assessment) {
    const bestLevel = (assessment.text_level ?? assessment.voice_level) as string | null;
    if (bestLevel && japaneseLevelMap[bestLevel]) {
      autoLevelJapanese = japaneseLevelMap[bestLevel];
      autoLevelLabelJapanese = japaneseLevelLabels[autoLevelJapanese] ?? null;
    }
  }
} catch {
  // No Japanese assessment found
}
---

<Layout title={t(lang, 'workbook.create.title')} user={user}>
  {generatingWorkbook ? (
    <section class="py-4 px-4">
      <GenerationProgress
        client:load
        slots={{
          topicLabel: generatingWorkbook.topic_label,
          levelLabel: generatingWorkbook.level_label,
          destLabel: generatingWorkbook.dest_label,
        }}
        resumeWorkbookId={generatingWorkbook.id}
        resumeDaysCompleted={generatingWorkbook.days_completed}
      />
    </section>
  ) : canCreate ? (
    <section class="py-4 px-4">
      <ChatBot
        client:load
        lang={lang}
        autoLevelEnglish={autoLevelEnglish}
        autoLevelLabelEnglish={autoLevelLabelEnglish}
        autoLevelJapanese={autoLevelJapanese}
        autoLevelLabelJapanese={autoLevelLabelJapanese}
      />
    </section>
  ) : (
    <section class="py-20 px-4 text-center">
      <div class="max-w-md mx-auto">
        <div class="text-5xl mb-4">ğŸ“š</div>
        <h2 class="text-xl font-semibold text-gray-700 mb-2">{t(lang, 'workbook.create.monthlyLimit')}</h2>
        <p class="text-gray-500 mb-6">{t(lang, 'workbook.create.monthlyLimitDesc')}</p>
        <a href="/workbook" class="px-6 py-3 bg-orange-500 text-white rounded-full font-medium hover:bg-orange-600 transition-colors">
          {t(lang, 'workbook.create.backToList')}
        </a>
      </div>
    </section>
  )}
</Layout>
