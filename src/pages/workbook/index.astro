---
import Layout from '../../layouts/Layout.astro';
import { WorkbookCard } from '../../components/workbook/WorkbookCard';
import { getUserWorkbooks, getPublicWorkbooks, getSampleWorkbooks } from '../../lib/workbook/db';
import { t } from '../../i18n/index';
import type { Lang } from '../../i18n/index';

const user = Astro.locals.user;
const lang = Astro.locals.lang as Lang;
const supabase = Astro.locals.supabase;

const wbLang = Astro.url.searchParams.get('lang') === 'japanese' ? 'japanese' : 'english';
const tab = Astro.url.searchParams.get('tab') === 'public' ? 'public' : 'mine';

let myWorkbooks: Awaited<ReturnType<typeof getUserWorkbooks>> = [];
let publicWorkbooks: Awaited<ReturnType<typeof getPublicWorkbooks>> = [];
let sampleEnglish: Awaited<ReturnType<typeof getSampleWorkbooks>> = [];
let sampleJapanese: Awaited<ReturnType<typeof getSampleWorkbooks>> = [];
let isPremium = false;

if (supabase) {
  sampleEnglish = await getSampleWorkbooks(supabase, 'english');
  sampleJapanese = await getSampleWorkbooks(supabase, 'japanese');

  if (user) {
    const { data: subs } = await supabase
      .from('subscriptions')
      .select('status')
      .eq('user_id', user.id)
      .in('status', ['active', 'trialing'])
      .limit(1);
    isPremium = (subs?.length ?? 0) > 0;

    if (isPremium) {
      if (tab === 'mine') {
        myWorkbooks = await getUserWorkbooks(supabase, user.id);
      } else {
        publicWorkbooks = await getPublicWorkbooks(supabase);
      }
    }
  }
}

// Filter by selected language
const filteredMy = myWorkbooks.filter(wb => (wb.language || 'english') === wbLang && !wb.is_public);
const filteredPublic = publicWorkbooks.filter(wb => (wb.language || 'english') === wbLang);
const filteredWorkbooks = tab === 'mine' ? filteredMy : filteredPublic;
const samples = wbLang === 'japanese' ? sampleJapanese : sampleEnglish;
---

<Layout title={t(lang, 'nav.workbook')} user={user}>
  <section class="py-12 px-4">
    <div class="max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">{t(lang, 'workbook.myWorkbooks')}</h1>
          <p class="text-gray-500 mt-1">{t(lang, 'workbook.subtitle')}</p>
        </div>
        {isPremium && (
          <a
            href="/workbook/create"
            class="px-6 py-3 bg-orange-500 text-white rounded-full font-medium hover:bg-orange-600 transition-colors"
          >
            {t(lang, 'workbook.newWorkbook')}
          </a>
        )}
      </div>

      {/* Language tabs (top level) */}
      <div class="flex gap-2 mb-4">
        <a
          href={`/workbook?tab=${tab}`}
          class:list={[
            'px-5 py-2 rounded-full text-sm font-medium border-2 transition-colors',
            wbLang === 'english'
              ? 'border-orange-400 bg-orange-50 text-orange-700'
              : 'border-gray-200 bg-white text-gray-500 hover:border-gray-300',
          ]}
        >
          {t(lang, 'workbook.lang.english')}
        </a>
        <a
          href={`/workbook?lang=japanese&tab=${tab}`}
          class:list={[
            'px-5 py-2 rounded-full text-sm font-medium border-2 transition-colors',
            wbLang === 'japanese'
              ? 'border-orange-400 bg-orange-50 text-orange-700'
              : 'border-gray-200 bg-white text-gray-500 hover:border-gray-300',
          ]}
        >
          {t(lang, 'workbook.lang.japanese')}
        </a>
      </div>

      {isPremium ? (
        <>
          {/* Sub-tabs: Mine / Public */}
          <div class="flex gap-1 mb-6 bg-gray-100 rounded-xl p-1 max-w-xs">
            <a
              href={`/workbook${wbLang === 'japanese' ? '?lang=japanese' : ''}`}
              class:list={[
                'flex-1 text-center px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                tab === 'mine' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500 hover:text-gray-700',
              ]}
            >
              {t(lang, 'workbook.tab.mine')}
            </a>
            <a
              href={`/workbook?tab=public${wbLang === 'japanese' ? '&lang=japanese' : ''}`}
              class:list={[
                'flex-1 text-center px-4 py-2 rounded-lg text-sm font-medium transition-colors',
                tab === 'public' ? 'bg-white text-gray-800 shadow-sm' : 'text-gray-500 hover:text-gray-700',
              ]}
            >
              {t(lang, 'workbook.tab.public')}
            </a>
          </div>

          {filteredWorkbooks.length === 0 ? (
            <div class="text-center py-20">
              <div class="text-5xl mb-4">{tab === 'mine' ? 'üìö' : 'üåç'}</div>
              <h2 class="text-xl font-semibold text-gray-700 mb-2">
                {tab === 'mine' ? t(lang, 'workbook.noWorkbooks') : t(lang, 'workbook.noPublicWorkbooks')}
              </h2>
              <p class="text-gray-500 mb-6">
                {tab === 'mine' ? t(lang, 'workbook.noWorkbooksDesc') : t(lang, 'workbook.noPublicWorkbooksDesc')}
              </p>
              {tab === 'mine' && (
                <a href="/workbook/create" class="px-6 py-3 bg-orange-500 text-white rounded-full font-medium hover:bg-orange-600 transition-colors">
                  {t(lang, 'workbook.createBtn')}
                </a>
              )}
            </div>
          ) : (
            <div class="grid md:grid-cols-2 gap-6">
              {filteredWorkbooks.map(wb => (
                <WorkbookCard client:load workbook={wb} showAuthor={tab === 'public'} />
              ))}
            </div>
          )}
        </>
      ) : (
        <>
          {/* Sample workbooks for non-premium users */}
          {samples.length > 0 && (
            <div class="mb-10">
              <p class="text-gray-500 mb-4 text-sm">{t(lang, 'workbook.samples.desc')}</p>
              <div class="grid md:grid-cols-2 gap-6">
                {samples.map(wb => (
                  <WorkbookCard client:load workbook={wb} showAuthor={false} />
                ))}
              </div>
            </div>
          )}

          {/* Premium upsell */}
          <div class="text-center py-12 bg-gradient-to-br from-orange-50 to-amber-50 rounded-2xl border border-orange-200">
            <div class="text-5xl mb-4">&#11088;</div>
            <h2 class="text-xl font-semibold text-gray-700 mb-2">{t(lang, 'workbook.premiumFeature')}</h2>
            <p class="text-gray-500 mb-6">{t(lang, 'workbook.premiumDesc')}</p>
            {!user ? (
              <a href="/login" class="px-6 py-3 bg-orange-500 text-white rounded-full font-medium hover:bg-orange-600 transition-colors">
                {t(lang, 'workbook.loginBtn')}
              </a>
            ) : (
              <a href="/community" class="px-6 py-3 bg-orange-500 text-white rounded-full font-medium hover:bg-orange-600 transition-colors">
                {t(lang, 'workbook.premiumBtn')}
              </a>
            )}
          </div>
        </>
      )}
    </div>
  </section>
</Layout>
